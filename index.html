<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ảnh trên Màn hình LED</title>
    
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tải React và ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Tải Babel để chuyển đổi JSX trong trình duyệt -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tải html2canvas để lưu ảnh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Tải font Inter từ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* Áp dụng font Inter cho toàn bộ trang */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Phần tử gốc để React render ứng dụng vào -->
    <div id="root"></div>

    <!-- Mã React của bạn sẽ được đặt ở đây -->
    <script type="text/babel">
        // Import các hook cần thiết từ React
        const { useState, useRef, useEffect } = React;

        const App = () => {
            const [imageSrc, setImageSrc] = useState(null);
            const [ledGrid, setLedGrid] = useState([]);
            const [density, setDensity] = useState('medium');
            const [aspectRatio, setAspectRatio] = useState('1 / 1'); // State cho tỷ lệ khung hình
            const [isSaving, setIsSaving] = useState(false); // State cho quá trình lưu
            const fileInputRef = useRef(null);
            const canvasRef = useRef(null);
            const displayContainerRef = useRef(null); // Ref cho toàn bộ vùng hiển thị

            // Cài đặt mật độ điểm ảnh và kích thước lưới
            const DENSITY_SETTINGS = {
                low: { gridSize: 20, dotSize: 16 },
                medium: { gridSize: 40, dotSize: 10 },
                high: { gridSize: 60, dotSize: 6 },
                superHigh: { gridSize: 85, dotSize: 4 },
                extreme: { gridSize: 120, dotSize: 3 },
            };

            const { gridSize, dotSize } = DENSITY_SETTINGS[density];
            
            // Xử lý khi người dùng tải ảnh lên
            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImageSrc(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Hàm chính để chuyển đổi ảnh thành lưới LED
            const processImageToLEDGrid = (img) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                setAspectRatio(`${img.naturalWidth} / ${img.naturalHeight}`);
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const newLedGrid = [];
                const cellWidth = canvas.width / gridSize;
                const cellHeight = canvas.height / gridSize;

                for (let y = 0; y < gridSize; y++) {
                    for (let x = 0; x < gridSize; x++) {
                        const imageData = ctx.getImageData(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                        const pixels = imageData.data;
                        let r = 0, g = 0, b = 0, count = 0;
                        for (let i = 0; i < pixels.length; i += 4) {
                            r += pixels[i];
                            g += pixels[i + 1];
                            b += pixels[i + 2];
                            count++;
                        }
                        if (count > 0) {
                            newLedGrid.push({
                                color: `rgb(${Math.floor(r / count)}, ${Math.floor(g / count)}, ${Math.floor(b / count)})`,
                                id: `${x}-${y}`
                            });
                        }
                    }
                }
                setLedGrid(newLedGrid);
            };

            // useEffect để xử lý khi ảnh hoặc mật độ thay đổi
            useEffect(() => {
                if (imageSrc) {
                    const img = new Image();
                    img.onload = () => processImageToLEDGrid(img);
                    img.src = imageSrc;
                } else {
                    setAspectRatio('1 / 1');
                }
            }, [imageSrc, density]);

            // Xử lý khi người dùng nhấp vào nút để chọn tệp
            const handleButtonClick = () => {
                fileInputRef.current.click();
            };

            // Hàm để lưu lưới LED thành ảnh JPG
            const handleSaveImage = () => {
                if (!displayContainerRef.current || !imageSrc) return;
                setIsSaving(true);
                html2canvas(displayContainerRef.current, { 
                    backgroundColor: '#000000', // Đặt nền đen cho ảnh
                    useCORS: true,
                }).then(canvas => {
                    const image = canvas.toDataURL('image/jpeg', 0.9);
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = 'led-art.jpg';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setIsSaving(false);
                }).catch(err => {
                    console.error("Oops, something went wrong!", err);
                    setIsSaving(false);
                });
            };

            // Xác định khoảng cách lưới dựa trên mật độ
            const gridGap = (density === 'high' || density === 'superHigh' || density === 'extreme') ? 'gap-[1px]' : 'gap-1';

            // Hàm để lấy tên hiển thị cho các nút mật độ
            const getDensityLabel = (d) => {
                switch (d) {
                    case 'low': return 'Thấp';
                    case 'medium': return 'TB';
                    case 'high': return 'Cao';
                    case 'superHigh': return 'S.Cao';
                    case 'extreme': return 'Cực Cao';
                    default: return '';
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-900 text-white">
                    <h1 className="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-6">Ảnh trên Màn hình LED</h1>

                    {/* Vùng điều khiển */}
                    <div className="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg w-full max-w-4xl mb-6">
                        <div className="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0 items-center justify-between">
                            <div className="flex space-x-2 w-full md:w-auto">
                                <button
                                    onClick={handleButtonClick}
                                    className="w-full py-3 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all transform hover:scale-105"
                                >
                                    Tải ảnh
                                </button>
                                <button
                                    onClick={handleSaveImage}
                                    disabled={!imageSrc || isSaving}
                                    className="w-full py-3 px-6 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-all transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:transform-none"
                                >
                                    {isSaving ? 'Đang lưu...' : 'Lưu ảnh'}
                                </button>
                            </div>
                            <input
                                type="file"
                                accept="image/*"
                                ref={fileInputRef}
                                onChange={handleImageUpload}
                                className="hidden"
                            />
                            <div className="w-full md:w-auto">
                                <label className="block text-sm font-medium text-gray-300 mb-2 md:hidden">Mật độ:</label>
                                <div className="flex space-x-1 bg-gray-700 p-1 rounded-lg">
                                    {['low', 'medium', 'high', 'superHigh', 'extreme'].map((d) => (
                                        <button
                                            key={d}
                                            onClick={() => setDensity(d)}
                                            className={`w-full sm:w-auto px-3 py-2 text-xs sm:text-sm font-medium rounded-md transition-colors
                                                ${density === d ? 'bg-green-500 text-white shadow-md' : 'bg-transparent text-gray-300 hover:bg-gray-600'}`}
                                        >
                                            {getDensityLabel(d)}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Màn hình hiển thị LED */}
                    <div 
                        ref={displayContainerRef} // **THAY ĐỔI: Ref được chuyển ra khung chứa bên ngoài**
                        className="w-full max-w-4xl bg-black rounded-xl p-4 shadow-lg flex items-center justify-center border-2 border-gray-700 transition-all duration-300"
                        style={{ aspectRatio: aspectRatio }}
                    >
                        {imageSrc ? (
                            <div
                                className={`grid ${gridGap} transition-all duration-300 w-full h-full`}
                                style={{
                                    gridTemplateColumns: `repeat(${gridSize}, 1fr)`,
                                }}
                            >
                                {ledGrid.map((dot) => (
                                    <div
                                        key={dot.id}
                                        className="aspect-square rounded-full transition-colors duration-100 ease-in-out flex items-center justify-center"
                                        style={{
                                            backgroundColor: dot.color,
                                            boxShadow: `0 0 ${dotSize / 2.5}px ${dot.color}, 0 0 ${dotSize / 1.5}px ${dot.color}20`,
                                        }}
                                    >
                                        <div 
                                            className="w-full h-full rounded-full"
                                            style={{
                                                width: `${dotSize}px`,
                                                height: `${dotSize}px`,
                                            }}
                                        />
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-gray-400 text-lg text-center p-8">
                                <svg xmlns="http://www.w3.org/2000/svg" className="mx-auto h-12 w-12 text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Vui lòng tải lên một bức ảnh để bắt đầu.
                            </div>
                        )}
                    </div>

                    {/* Canvas ẩn để xử lý ảnh */}
                    <canvas ref={canvasRef} className="hidden"></canvas>
                </div>
            );
        };

        // Render thành phần App vào phần tử 'root'
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
